---
date: 2024-10-23
tags:
  - Онлайн-школа
---
# RssModule

Контроллер предназначен для генерации и получения RSS ленты учебных материалов с типом статья.

## RssController

Позволяет получить RSS ленту.

***

### Ednpoints

Контроллер предоставляет следующий эндпоинт:

| Метод | URL    | Описание            |
| ----- | ------ | ------------------- |
| GET   | `rss/` | Получение RSS ленты |

***

### Получить RSS ленту

`get rss/`

*Входные данные:*

- Query параметр номера страницы. Если не указан используется первая страница - `paged?: string`

*Функционал:*

Сперва метод проверяет загружен ли RSS Feed в виде строки, если нет, то запрашивает его. В случае ошибки получения выбрасывает ошибку.

Извлекаются элементы из ленты, и вычисляется общее количество элементов и страниц. Если переданный номер страницы неверен (например, меньше 1 или больше общего количества страниц), возвращает базовую структуру RSS-канала.

Извлекает элементы указанной страницы, конвертирует ленту в XML и возвращает результат. В случае ошибки выбрасывает исключение с сообщением об ошибке.

*Выходные данные:* Status: `200 OK`

Возвращает объект, содержащий сформированный RSS Feed в формате XML.

## RssService

***

Предоставляет следующие методы:

| Имя                     | Описание                                        |
| ----------------------- | ----------------------------------------------- |
| onModuleInit            | Инициализация модуля                            |
| getArticlesFromDataBase | Получение статей из БД                          |
| generateRssFeed         | Генерация RSS ленты                             |
| getRssFeed              | Получение RSS ленты                             |
| uploadRssFileToS3       | Генерация и загрузка RSS ленты в S3             |
| getBaseFeed             | Получить базовую структуру RSS канала           |
| convertToXml            |                                                 |
| clearRssCache           | Очиста кэша для RSS ленты и повторная генерация |

***

### onModuleInit

*Входные данные:* -

*Функционал:*

Создает случайный таймер задержки, по истечении которого, вызывает метод `getArticlesFromDataBase` для получения статей из базы данных. В случае ошибки выводит сообщение в лог.

*Выходные данные:* -

### getArticlesFromDataBase

*Входные данные:* -

*Функционал:*

Сначала производится проверка в кэше Redis по ключу `rss:running`, не выполняется ли уже получение статей из базы данных.

Если процесс уже выполняется, метод пытается получить ленту RSS в виде строки и в случае успеха парсит ее, в противном случае вызывает `clearRssCache` для очистки кэша RSS ленты и ее повторной генерации.

Если процесс не выполняется, метод сначала очищает кэш RSS ленты, а затем меняет значение ключа Redis на true с истечением через 48 часов.

*Выходные данные:* -

### generateRssFeed

*Входные данные:*

- Массив учебных материалов (Material):

```json
{
  id: string;
  createdAt: Date;
  name: string;
  status: CatalogStatus('ARCHIVE', 'ACTIVE');
  subTitle?: string | null;
  description?: string | null;
  catalogId?: string | null;
  uploadId?: string | null;
  upload?: Upload | null;
  testId?: string | null;
  textbookId?: string | null;
  textbook?: Textbook | null;
  link?: string | null;
  previewUrl?: string | null;
  userId?: string | null;
  taskId?: string | null;
  isInvisible: boolean;
}
```

*Функционал:*

Метод получает базовую структуру RSS ленты, затем проверяет для каждого элемента переданного массива, что указан урок, статья и ссылка. Проверяет Slug на уникальность и формирует для каждого материала HTML содержимое элемента RSS ленты.

При наличии ссылки на урок создает новый элемент в RSS-ленте, внутри которого добавляются заголовок, дата публикации, ссылка, подготовленное содержимое и, при наличии, изображение. После обработки всех материалов возвращает сгенерированную ленту.

*Выходные данные:*

Возвращает подготовленную RSS ленту в виде строки.

### getRssFeed

*Входные данные:*

- Номер страницы ленты, если не указан используется первая страница - `paged?: string`

*Функционал:*

Сперва метод проверяет загружен ли RSS Feed в виде строки, если нет, то запрашивает его. В случае ошибки получения выбрасывает ошибку.

Извлекаются элементы из ленты, и вычисляется общее количество элементов и страниц. Если переданный номер страницы неверен (например, меньше 1 или больше общего количества страниц), возвращает базовую структуру RSS-канала.

Извлекает элементы указанной страницы, конвертирует ленту в XML и возвращает результат. В случае ошибки выбрасывает исключение с сообщением об ошибке.

*Выходные данные:*

Возвращает объект, содержащий сформированный RSS Feed в виде XML строки.

### uploadRssFileToS3

*Входные данные:* -

*Функционал:*

Перед началом работы и после каждого этапа выполняется логгирование времени выполнения.

Получает активные материалы с типом "Статья" для RSS ленты из базы данных. Если материалы были получены, генерирует RSS ленту в виде строки при помощи `generateRssFeed`. Затем парсит ее и сохраняет в хранилище S3.

*Выходные данные:* -

### getBaseFeed

*Входные данные:* -

*Функционал:*

Подготавливает и возвращает базовую структуру RSS ленты.

*Выходные данные:*

Метод возвращает объект XMLBuilder

### convertToXml

*Входные данные:*

```json
data: {
  rss: {
    channel: {
      item: RssItem[];
    };
  };
}
```

```json
RssItem {
  title: string;
  link: string;
  description: string;
  pubDate: string;
  enclosure: Enclosure;
  'turbo:content': string;
}
```

*Функционал:*

Получает базовую структуру RSS ленты и извлекает элементы из переданного объекта. Подготавливает RSS данные для каждого элемента и возвращает сформированный объект.

*Выходные данные:*

Возвращает подготовленный объект в виде XML строки.

### clearRssCache

*Входные данные:* -

*Функционал:*

Перед началом работы и после каждого этапа выполняется логгирование времени выполнения.

Метод последовательно выполняет следующие операции: удаляет `rss.xml`, удаляет данные из Redis по ключу `rss:running`, вызывает метод `uploadRssFileToS3` для генерации и сохранения RSS ленты в хранилище S3.

*Выходные данные:* `true`

***

## Зависимости (импортируемые модули)

- MaterialModule

***

## Используемый стэк

- JavaScript
- NestJS
- TypeScript
- Node.js