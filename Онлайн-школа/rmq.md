---
date: 2024-10-22
tags:
  - Онлайн-школа
---
# RmqModule

Предназначен для работы с сообщениями RabbitMQ. Модуль не предоставляет никаких эндпоинтов.

***

## RmqService

Предоставляет следующие методы:

| Имя              | Описание                           |
| ---------------- | ---------------------------------- |
| onModuleInit     | Установление соединения            |
| onModuleDestroy  | Закрытие соединения                |
| getChannel       | Поиск или создание канала по имени |
| sendMessage      | Отправка сообщения                 |
| subscribe        | Подписка на сообщения из очереди   |
| ack              | Подтверждение обработки сообщения  |
| reject           | Отклонение сообщений               |
| assert           | Связывание обменника и очереди     |
| getChannelByName | Поиск канала по имени              |
| connect          | Установление соединения            |
| disconnect       | Закрытие соединения                |
| reconnect        | Повторное подключение              |

***

### onModuleInit

*Входные данные:* -

*Функционал:*

Вызывает метод [connect](#connect) для установления соединения с RabbitMQ.

*Выходные данные:* -

### onModuleDestroy

*Входные данные:* - 

*Функционал:*

Вызывает метод [disconnect](#disconnect) для закрытия соединения с RabbitMQ.

*Выходные данные:* -

### getChannel

*Входные данные:*

```json
{
  name: string;
}
```

*Функционал:*

Метод пытается получить канал по указанному имени, если канала с таким названием не существует, создает новый канал.

*Выходные данные:*

Возвращает объект найденного или созданного канала.

### sendMessage

*Входные данные:*

```json
{
  channel: string;
  exchange: string;
  content: T;
  options?: Options.Publish;
} & (
  | {
      queue: string;
      routingKey?: never;
    }
  | {
      routingKey: string;
      queue?: never;
    }
);
```

```json
Options.Publish {
  expiration?: string | number | undefined;
  userId?: string | undefined;
  CC?: string | string[] | undefined;

  mandatory?: boolean | undefined;
  persistent?: boolean | undefined;
  deliveryMode?: boolean | number | undefined;
  BCC?: string | string[] | undefined;

  contentType?: string | undefined;
  contentEncoding?: string | undefined;
  headers?: any;
  priority?: number | undefined;
  correlationId?: string | undefined;
  replyTo?: string | undefined;
  messageId?: string | undefined;
  timestamp?: number | undefined;
  type?: string | undefined;
  appId?: string | undefined;
}
```

*Функционал:*

Сначала метод выполняет проверку на дублирование - проверяется существует ли уже такое сообщение в Redis. Если оно существует, метод возвращает `false`, чтобы предотвратить повторную отправку. Если сообщение не найдено в Redis, оно добавляется с установленным значением `true` и временем жизни 30 секунд.

Затем метод выполняет поиск канала RabbitMQ и если он не был найден, то создает его. После это выполняется отправка сообщения. Если в ходе отправки сообщения возникла ошибка, в лог будет выведена соответствующая запись.

*Выходные данные:*

Возвращает `true`, если сообщение не было найдено в Redis и было успешно отправлено в канал.

### subscribe

*Входные данные:*

```json
{
  channelName: string;
  ...paramsArr: SubscribeToMessageParams<T>[];
}
```

```json
SubscribeToMessageParams {
  handler: (msg: T, amqpMsg: ConsumeMessage, redelivered: boolean) => void;
  options?: Options.Consume;
  prefetchCount?: number;
  routingKeys?: string[];
}
```

*Функционал:*

Метод создает новый канал, настраивает его для обработки сообщений. Настраивает обменник и очередь, связывая их с ключами маршрутизации, затем подписывается на указанную очередь, устанавливая обработчик, который будет вызываться при получении сообщений.

При получении сообщения метод извлекает его идентификатор и проверяет, было ли оно уже обработано, используя Redis. Если сообщение не было обработано ранее, оно передается в обработчик, который выполняет необходимую логику обработки. В зависимости от результата обработки, состояние сообщения обновляется в Redis.

*Выходные данные:* -

### ack

*Входные данные:*

```json
{
  channelName: string;
  amqpMsg: Message | null;
}
```

```json
Message {
  content: Buffer;
  fields: MessageFields;
  properties: MessageProperties;
}
```

*Функционал:*

Получает канал по указанному имени либо создает его. Если параметр сообщения `redelivered` равен `false`, подтверждает его, в противном случае выводит ошибку в лог.

*Выходные данные:* -

### reject

*Входные данные:*

```json
{
  channelName: string;
  amqpMsg: Message | null;
  requeue = false;
}
```

```json
Message {
  content: Buffer;
  fields: MessageFields;
  properties: MessageProperties;
}
```

*Функционал:*

Получает канал по указанному имени либо создает его. Отклоняет сообщение, не помещая его обратно в очередь. В случае возникновения ошибки, выводит сообщение в лог. 

*Выходные данные:* -

### assert

*Входные данные:*

```json
{
  channel: amqp.Channel;
  params: AssertParams;
  routingKeys?: string[];
}
```

```json
AssertParams {
  queue: string;
  exchange: string;
  exchangeType?: 'direct' | 'topic' | 'fanout' | 'headers';
  queueOptions?: Options.AssertQueue;
  exchangeOptions?: Options.AssertExchange;
}
```

*Функционал:*

Сперва метод проверяет существование обменника или создает его с заданным именем и типом, затем проверяет существование или создает очередь с переданным именем.

В случае, если были переданы `routingKeys`, для каждого ключа связывает очередь с обменником, в противном случае связывает очередь с обменником, используя имя очереди в качестве ключа.

*Выходные данные:* -

### getChannelByName

*Входные данные:*

```json
{
  name: string;
}
```

*Функционал:*

Метод пытается получить канал по указанному имени, если канала с таким названием не существует, возвращает `undefined`.

*Выходные данные:*

Возвращает объект найденного канала либо `undefined`.

### connect

*Входные данные:* -

*Функционал:*

Метод разбивает параметры соединения с сервером RabbitMQ на массивы и приводит их к одинаковой длине, а затем объединяет в один массив. Устанавливает соединение с использованием подготовленных параметров и обрабатывает события состояний соединения (ошибки, закрытие соединения и неудачные попытки подключения).

После успешного подключения создаются каналы и выводится сообщение о успешном подключении к RabbitMQ.

*Выходные данные:* -

### disconnect

*Входные данные:* -

*Функционал:*

Метод сначала проверяет, существует ли текущее соединение с RabbitMQ, если оно существует закрывает его. После этого проверяет существование таймера повторного подключения, если он существует, очищает его.

*Выходные данные:* -

### reconnect

*Входные данные:* -

*Функционал:*

Для каждого канала вызывается метод `close`, который закрывает канал, в случае возникновения ошибки, записывает ее в лог. После этого закрывает соединение с RabbitMQ, удаляет каналы и очищает таймер переподключения.

После этого проверяется, достигнуто ли максимальное количество попыток переподключения. Если да, то выводится сообщение об ошибке, и метод завершает выполнение. Если максимальное количество попыток еще не достигнуто, устанавливает таймер, который через заданный интервал вызывает повторное подключение, увеличивая счетчик текущих попыток переподключения.

*Выходные данные:* -

***

## Используемый стэк

- JavaScript
- NestJS
- TypeScript
- Node.js