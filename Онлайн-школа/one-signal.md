---
date: 2024-10-09
tags:
  - Онлайн-школа
---
# OneSignalModule

Модуль предназначен для получения данных уведомлений.

## OneSignalController

Получает уведомления для конкретного пользователя на основе переданных параметров. В контроллере используется ThrottlerGuard для ограничения количества запросов.

***

### Endpoints

Контроллер предоставляет следующие эндпоинты:

| Метод | URL                             | Описание              |
| ----- | ------------------------------- | --------------------- |
| POST  | `onesignal/user-notifications/` | Получение уведомлений |

***

### Получение уведомлений

`POST onesignal/user-notifications/`

*Входные данные:*

- В тело запроса должны быть переданы следующие параметры (OneSignalUserNotificationDto):

```json
{
  id?: string;
  tags?: Record<string, number>[];
}
```

*Функционал:*

Работа метода разделена на несколько этапов:

1. Сначала вызывается метод `getAllNotificationsData()`, который отправляет GET запрос с параметром offset, равным 0 и использует идентификатор приложения `ONE_SIGNAL_APP_ID`, для получения общего количества количества уведомлений
2. На основе полученного количества метод рассчитывает значение `offsetCount` производя деление на 50. Это значение будет использоваться для определения количества страниц уведомлений, которые необходимо запросить.
3. Метод вызывает `getReqArr(offsetCount)`, передавая рассчитанное значение. Функция создает и выполняет несколько параллельных запросов при помощи `getAllNotificationsData` для получения уведомлений, начиная с указанного смещения offset и заканчивая нулем.
4. После получения данных метод извлекает массив уведомлений из результатов запросов. Если уведомления не были получены, метод возвращает пустой массив.
5. Создается пустой массив `userNotifications`, который будет использоваться для хранения уведомлений, соответствующих параметрам, переданным в запросе.
6. Метод извлекает в массивы `subjectsIds` и `classesValues` идентификаторы тегов из параметров запроса, которые будут использоваться для фильтрации уведомлений по `subjectId` и `className`.
7. Фильтрация уведомлений:
	- Если уведомление содержит массив `include_external_user_ids`, и переданный идентификатор пользователя присутствует в этом массиве, уведомление добавляется в массив `userNotifications`.
    - Если данные уведомления содержат объект `data`, и `subjectId` совпадает с любым из переданных тегов, уведомление также добавляется в массив.
    - Точно также, в случае если `className` уведомления совпадает с любым из значений тегов, уведомление добавляется в массив.
8. В конце метод возвращает массив `userNotifications`, который содержит все уведомления, соответствующие параметрам, переданным в запросе.

*Выходные данные:* Status: `200 OK`

Возвращает массив уведомлений, соответствующий параметрам запроса.

```json
Record<string, Record<string, unknown>>[]
```

***

## Зависимости (импортируемые модули)

- HttpModule

***

## Используемый стэк

- JavaScript
- NestJS
- TypeScript
- Node.js