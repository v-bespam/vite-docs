---
date: 2024-09-30
tags:
  - ОШ-1-сайт
---
Контроллер предназначен для получения информации о новостях.

### Endpoints

Контроллер предоставляет следующие эндпоинты:

| Метод | URL                          | Описание                                                                                    |
| ----- | ---------------------------- | ------------------------------------------------------------------------------------------- |
| GET   | `nest/api/news/`             | [[#Получение информации для страницы новостей\|Получение информации для страницы новостей]] |
| GET   | `nest/api/news/all`          | [[#Получение списка всех новостей\|Получение списка всех новостей]]                         |
| GET   | `nest/api/news/detail/:code` | [[#Получение подробной информации о новости\|Получение подробной информации о новости]]     |

### Получение информации для страницы новостей

`GET nest/api/news/`

*Входные данные:* отсутствуют

*Функционал:*

Выполняет поиск в кэше Redis по ключу `news-page-info`, если данные не найдены, подготавливает их:

1. Выполняет запрос к Strapi для получения блоков страницы NewsPageInfo (API ID: news-page-info).
2. Выполняет поиск в кэше разделов новостей Redis по ключу `news-sections`, если данные не найдены, запрашивает коллекцию Strapi NewsSections (API ID: news-section). Сохраняет данные в кэш и возвращает их
3. Добавляет хлебные крошки
4. Сохраняет сформированные данные в кэш и возвращает их

*Выходные данные:* Status: `200 OK`

Возвращает объект с данными страницы NewsPageInfo, список разделов новостей коллекции NewsSections из Strapi и хлебные крошки.

### Получение списка всех новостей

`GET nest/api/news/all`

*Входные данные:*

- Query параметры о пагинации:

| Параметр | Тип данных | Валидация    | Описание                      |
| -------- | ---------- | ------------ | ----------------------------- |
| section  | string     | Опциональный | Код секции                    |
| limit    | number     | Опциональный | Количество новостей           |
| offset   | number     | Опциональный | Количество пропуска элементов |

*Функционал:*

Выполняет поиск в кэше Redis по ключу `news`, если данные не найдены, выполняет запрос к Strapi для получения коллекции SchoolNews (API ID: school-news) с сортировкой в порядке уменьшения (первыми в списке будут последние новости). offset по умолчанию равен 0, а limit — 11

*Выходные данные:* Status: `200 OK`

Возвращает объект, содержащий массив новостей. Поле `hasMoreNews` равно `true` если есть новости не добавленные в массив.

```json
{
hasMoreNews: boolean;
news: News[]
}
```

News:

```json
{
  authorName: string | null;
  code: string;
  id: number;
  published_at: Date;
  section: NewsSection;
  text: string;
  title: string;
  meta?: Meta;
  img?: Image;
}
```

### Получение подробной информации о новости

`GET nest/api/news/detail/:code`

*Входные данные:*

- В запросе должен быть передан код курса - `code: string`

*Функционал:*

Выполняет поиск в кэше Redis по ключу `news:${code}`, если данные не найдены, подготавливает их:

1. Выполняет запрос к Strapi для получения элемента коллекции SchoolNews (API ID: school-news), с указанным кодом.
2. Выполняет поиск в кэше Redis по ключу `news-page-info` общей информации о странице новостей. Если данные не найдены:
	1. Выполняет запрос к Strapi для получения блоков страницы NewsPageInfo (API ID: news-page-info)
	2. Выполняет поиск в кэше разделов новостей Redis по ключу `news-sections`, если данные не найдены, запрашивает коллекцию Strapi NewsSections (API ID: news-section). Сохраняет данные в кэш и возвращает их
	3. Формирует хлебные крошки
	4. Сохраняет сформированные данные в кэш и возвращает их
4. Добавляет к хлебным крошкам заголовок новости, блоки Strapi SocialLinks, WelcomeBlock, Form
5. Сохраняет данные в кэш и возвращает их

В случае если новость с указанным кодом не найдена, выбрасывает исключение с текстом "News not found".

*Выходные данные:* Status: `200 OK`

Возвращает объект с подготовленными данными страницы указанной новости, содержащий блоки страницы NewsPageInfo, список разделов новостей коллекции NewsSections из Strapi и хлебные крошки.