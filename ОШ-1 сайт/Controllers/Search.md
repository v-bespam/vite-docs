---
date: 2024-09-30
tags:
  - ОШ-1-сайт
---
Контроллеры предназначен для очистки кэша Redis и работы с поиском на сайте при помощи Elasticsearch.
## CacheController

Позволяет очистить кэш Redis.

### Endpoints

Контроллер предоставляет следующий эндпоинт:

| Метод | URL                     | Описание                                    |
| ----- | ----------------------- | ------------------------------------------- |
| GET   | `nest/api/cache/clear/` | [[#Очистить кэш Redis\|Очистить кэш Redis]] |

### Очистить кэш Redis

`GET nest/api/cache/clear/`

*Входные данные:* Отсутствуют

*Функционал:*

При отправке запроса сначала вызывается `redisService.reset()`, который очищает весь кэш при помощи. Затем вызывается `searchService.createIndex()`, который пересоздает индекс Elasticsearch для поиска. В конце метод возвращает `true`.

При создании индекса Elasticsearch выполняются следующие операции:

1. Сначала проверяется, существует ли индекс. Если он существует, то он удаляется.
2. В массив, при помощи Strapi собираются данные для индексации в Elasticsearch (страницы, курсы, новости, учителя). Strapi выполняет подготовку данных и кеширует их в Redis.
3. Создается массив операций для индексации, где каждая операция включает в себя индексирование документа.
4. Создание индекса
5. Индексация данных
6. В конце выводится информация о завершении индексации и предупреждения о возможных ошибках.

*Выходные данные:* Status: `200 OK`

## SearchController

Позволяет выполнять поиск на сайте при помощи Elasticsearch.

### Endpoints

Контроллер предоставляет следующий эндпоинт:

| Метод | URL                | Описание                                                    |
| ----- | ------------------ | ----------------------------------------------------------- |
| GET   | `nest/api/search/` | [[#Выполнение поиска на сайте\|Выполнение поиска на сайте]] |

### Выполнение поиска на сайте

`GET nest/api/search/`

*Входные данные:*

- Query параметры с информацией о пагинации:

| Параметр | Тип данных | Валидация    | Описание                          |
| -------- | ---------- | ------------ | --------------------------------- |
| search   | string     | Обязательный | Текст для поиска                  |
| page     | number     | Опциональный | Номер страницы результатов поиска |
| limit    | number     | Опциональный | Ограничение результатов вывода    |

*Функционал:*

Выполняется проверка существования индекса поиска, если индекс не существует, выбрасывается исключение InternalServerErrorException с сообщением "Поиск переиндексируется". Если индекс существует, выполняет поиск согласно переданным параметрам.



*Выходные данные:* Status: `200 OK`

Возвращает объект с массивом данных о результатах поиска

```json
{
  total: number,
  hits: {
    url: string;
    title: string;
    text: string;
  }[]
}
```